<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.37" />
    <meta name="theme" content="VuePress Theme Hope" />
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3301431_8n341ft9wlf.css"><title>Spring | Mean Space</title><meta name="description" content="平均数空间，记录一些日常、非日常的思考">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/assets/style.f6a75c14.css">
    <link rel="modulepreload" href="/assets/app.6f02f33f.js"><link rel="modulepreload" href="/assets/Spring.html.3689ed9f.js"><link rel="modulepreload" href="/assets/Spring.html.9a61e1ce.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc sidebar-open"><!--[--><header class="navbar"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><a href="/" class="home-link"><!----><!----><span class="site-name hide-in-pad">Mean Space</span><!--[--><!----><!--]--></a><nav class="nav-links" style=""><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" arialabel="Home"><!---->Home<!----></a></div><div class="nav-item hide-in-mobile"><a href="/math/" class="nav-link" arialabel="Math"><!---->Math<!----></a></div><div class="nav-item hide-in-mobile"><a href="/science/" class="nav-link" arialabel="Science"><!---->Science<!----></a></div><div class="nav-item hide-in-mobile"><a href="/reading/" class="nav-link" arialabel="Reading"><!---->Reading<!----></a></div><div class="nav-item hide-in-mobile"><a href="/coding/" class="nav-link active" arialabel="Coding"><!---->Coding<!----></a></div><div class="nav-item hide-in-mobile"><a href="/stuff/" class="nav-link" arialabel="Stuff"><!---->Stuff<!----></a></div><div class="nav-item hide-in-mobile"><a href="/about/" class="nav-link" arialabel="About"><!---->About<!----></a></div></nav><div class="nav-actions-wrapper"><!--[--><!----><!--]--><div class="nav-item"><!----></div><!----><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewbox="0 0 1024 1024" arialabelledby="outlook"><title id="outlook" lang="en">outlook icon</title><g fill="currentColor"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></g></svg><div class="outlook-dropdown"><!----></div></button></div><!----><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button><!--[--><!----><!--]--></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/coding/" class="nav-link sidebar-link sidebar-page" arialabel="我是一个码农"><!---->我是一个码农<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/coding/DDD.html" class="nav-link sidebar-link sidebar-page" arialabel=" DDD"><!----> DDD<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/coding/Apache-Shiro.html" class="nav-link sidebar-link sidebar-page" arialabel="Apache Shiro Notes"><!---->Apache Shiro Notes<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/coding/Java-SPI.html" class="nav-link sidebar-link sidebar-page" arialabel="Java SPI"><!---->Java SPI<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/coding/Java-%E5%B9%B6%E5%8F%91.html" class="nav-link sidebar-link sidebar-page" arialabel="Java 并发"><!---->Java 并发<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/coding/Java%E6%97%A5%E5%BF%97.html" class="nav-link sidebar-link sidebar-page" arialabel="Java日志"><!---->Java日志<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/coding/GC.html" class="nav-link sidebar-link sidebar-page" arialabel="JVM GC"><!---->JVM GC<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/coding/Modern-PHP%E7%AE%80%E8%AE%B0.html" class="nav-link sidebar-link sidebar-page" arialabel="Modern PHP简记"><!---->Modern PHP简记<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/coding/Mybatis.html" class="nav-link sidebar-link sidebar-page" arialabel="Mybatis"><!---->Mybatis<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/coding/MySQL.html" class="nav-link sidebar-link sidebar-page" arialabel="MySQL"><!---->MySQL<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/coding/Spring.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" arialabel="Spring"><!---->Spring<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/coding/Spring.html#spring" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="Spring"><!---->Spring<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/coding/Spring.html#spring-mvc" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="Spring MVC"><!---->Spring MVC<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/coding/Spring.html#spring-boot" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="Spring Boot"><!---->Spring Boot<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/coding/Spring-IoC.html" class="nav-link sidebar-link sidebar-page" arialabel="Spring IoC"><!---->Spring IoC<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/coding/%E5%BC%80%E5%8F%91%E7%AE%A1%E7%90%86.html" class="nav-link sidebar-link sidebar-page" arialabel="开发管理 Notes"><!---->开发管理 Notes<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/coding/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84-Design-Pattern.html" class="nav-link sidebar-link sidebar-page" arialabel="微服务 Design Pattern"><!---->微服务 Design Pattern<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/coding/%E6%9E%B6%E6%9E%84%E6%80%9D%E6%83%B3.html" class="nav-link sidebar-link sidebar-page" arialabel="架构思想"><!---->架构思想<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/coding/%E5%85%AC%E5%B9%B3%E9%94%81-vs-%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81.html" class="nav-link sidebar-link sidebar-page" arialabel="锁事一二"><!---->锁事一二<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->Spring</h1><div class="article-info"><span class="author-info" arialabel="作者🖊" data-balloon-pos="down" isoriginal="false" pageview="false" color="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" arialabelledby="author"><title id="author" lang="en">author icon</title><g fill="currentColor"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></g></svg><span><span class="author-item">Li Zhuliang</span></span><span property="author" content="Li Zhuliang"></span></span><!----><span class="date-info" arialabel="写作日期📅" data-balloon-pos="down" isoriginal="false" pageview="false" color="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" arialabelledby="calendar"><title id="calendar" lang="en">calendar icon</title><g fill="currentColor"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></g></svg><span>2020年3月12日</span><meta property="datePublished" content="2020-03-12T06:16:44.000Z"></span><!----><!----><span class="reading-time-info" arialabel="阅读时间⌛" data-balloon-pos="down" isoriginal="false" pageview="false" color="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewbox="0 0 1024 1024" arialabelledby="timer"><title id="timer" lang="en">timer icon</title><g fill="currentColor"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></g></svg><span>大约 2 分钟</span><meta property="timeRequired" content="PT2M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc-list"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/coding/Spring.html#spring" class="router-link-active router-link-exact-active toc-link level2">Spring</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/coding/Spring.html#spring-mvc" class="router-link-active router-link-exact-active toc-link level3">Spring MVC</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/coding/Spring.html#spring-boot" class="router-link-active router-link-exact-active toc-link level3">Spring Boot</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><!--[--><h2 id="spring" tabindex="-1"><a class="header-anchor" href="#spring" aria-hidden="true">#</a> Spring</h2><h3 id="spring-mvc" tabindex="-1"><a class="header-anchor" href="#spring-mvc" aria-hidden="true">#</a> Spring MVC</h3><h4 id="关于-interceptor-和-filter" tabindex="-1"><a class="header-anchor" href="#关于-interceptor-和-filter" aria-hidden="true">#</a> 关于 Interceptor 和 Filter</h4><p>引用自StackOverflow：</p><blockquote><p>fine-grained handler-related preprocessing tasks are candidates for HandlerInterceptor implementations, especially factored-out common handler code and authorization checks. On the other hand, a Filter is well-suited for request content and view content handling, like multipart forms and GZIP compression. This typically shows when one needs to map the filter to certain content types (e.g. images), or to all requests.</p></blockquote><p>所以来说，做验证码校验的逻辑，应该是用 Interceptor 更为合适。But 由于 Filter 在 Interceptor 之前执行（优先级高，更底层），用 Interceptor 无法拦截到非法登录请求，还是要用 Filter。</p><ul><li>Filters are called by your Server(tomcat). while Interceptors are called by Spring.</li><li>filter is always executed BEFORE the preHandle interceptor method. <ul><li>interceptors are part of Spring MVC which begins at DispatcherServlet. Filters are called before servlets.</li></ul></li></ul><p><img src="https://cdn.jsdelivr.net/gh/wildcloud3/image_bed@master/2022/04/upgit_20220403_1648992562.png" alt="upload successful"></p><ul><li>最后用了 httpSecurity 的 addFilterBefore 在用户名密码验证前加了个 GeetestFilter</li></ul><h3 id="spring-boot" tabindex="-1"><a class="header-anchor" href="#spring-boot" aria-hidden="true">#</a> Spring Boot</h3><h4 id="环境变量获取的-hack-逻辑-springboot-2-中变化了很多-但还是支持的" tabindex="-1"><a class="header-anchor" href="#环境变量获取的-hack-逻辑-springboot-2-中变化了很多-但还是支持的" aria-hidden="true">#</a> 环境变量获取的 hack 逻辑（SpringBoot 2 中变化了很多，但还是支持的）</h4><ul><li>在 properties文件中一般是 a.b.c，但在环境变量中，A_B_C 也是可以被 DataBinder 到的，代码见：RelaxedDataBinder::getPropertyValuesForNamePrefix，会处理<code>_ 和 .</code>的分隔符</li><li>大小写变换的逻辑，在这个类：RelaxedNames</li></ul><h4 id="运行时配置" tabindex="-1"><a class="header-anchor" href="#运行时配置" aria-hidden="true">#</a> 运行时配置</h4><ol><li>准备多个 application-dev.properties, application-prod.properties，可以用 spring.profiles.active=xxx 来激活</li><li>部署时，根据优先级，在 java -jar -Dspring.profiles.active=prod 来激活</li><li>有 Apollo，Spring Cloud Bus，应该是用不到这个了</li></ol><h4 id="restcontroller-对于-response-的-pojo-会自动用-jackson-搞成json-这时时间类型的序列化会是个问题" tabindex="-1"><a class="header-anchor" href="#restcontroller-对于-response-的-pojo-会自动用-jackson-搞成json-这时时间类型的序列化会是个问题" aria-hidden="true">#</a> @RestController 对于 response 的 POJO 会自动用 Jackson 搞成json，这时时间类型的序列化会是个问题</h4><ul><li>Java8 之前，Date 类型，直接在注解上 <code>@JsonFormat(pattern = &#39;yyyy-MM-dd&#39;)</code></li><li>Java8 之后，LocalDate 相关类型，只上面不够，需要引入新的依赖</li></ul><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>&lt;dependency&gt;
    &lt;groupId&gt;com.fasterxml.jackson.datatype&lt;/groupId&gt;
    &lt;artifactId&gt;jackson-datatype-jsr310&lt;/artifactId&gt;
    &lt;version&gt;2.8.8&lt;/version&gt;
 &lt;/dependency&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>实现机制：</li></ul><ol><li>对于不指定的 POJO 返回，会默认调用到 Jackson 的 ObjectWriter</li><li>会 resolve 到相应的 ValueSerializer</li><li>第一次访问到这个时，BeanSerializerBase这个会构造（Lazy 的）</li><li>里面的 BeanPropertyWriter 里面有个_member 就是对应的类反射数据</li><li>可以根据_member 上的 Annotation 来构造相应的 Formatter</li></ol><h4 id="propertysources-相关" tabindex="-1"><a class="header-anchor" href="#propertysources-相关" aria-hidden="true">#</a> PropertySources 相关</h4><ul><li>在 populate Bean 时，对于<code>@Value</code>的 field，会尝试各种 resolver，到最后，会落到一堆 propertySouces 上，Genrally，越后被定义到的@PropertySources，会越先win</li><li>一个小问题，使用 app.setDefaultProperties 得到的 propertySource 是最低（最先定义）Priority 的 PropertySource，会被从 config-bus 那边的 CompositePropertySource 覆盖掉</li><li>转而设置 property 在 env 中，会用到 EnvironmentPropertySource 就可以了</li></ul><h4 id="如何优雅地用-factory-strategy模式" tabindex="-1"><a class="header-anchor" href="#如何优雅地用-factory-strategy模式" aria-hidden="true">#</a> 如何优雅地用 factory strategy模式</h4><ol><li>自己定义一个 annotation on runtime</li><li>给各个 handler/strategy/impl 上加这个 annotation，并指定好各自不同的type/value/sort 等</li><li>加一个 BeanFactoryPostProcessor 的实现，在beanFactory 初始化完成后，扫描指定包下含有此 annotation 的 class</li><li>提取此 annotation 中的 value，和对应的 class 的 impl做成一个 map，可以在 factory 中使用</li></ol><ul><li>如果使用 <code>@Autowired SomeInterface handlers[]</code> 这样的方式，一定要给所有的 impl 弄成bean，会需要多考虑一些线程问题</li></ul><!--]--></div><!----><footer class="page-meta"><!----><div class="meta-item update-time"><span class="label">上次编辑于: </span><span class="info">2022/7/25 12:57:28</span></div><div class="meta-item contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: lizhuliang@quancheng-ec.com">lizhuliang</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/coding/MySQL.html" class="nav-link prev" arialabel="MySQL"><div class="hint"><span class="arrow left"></span>上一页</div><div class="link"><!---->MySQL</div></a><a href="/coding/Spring-IoC.html" class="nav-link next" arialabel="Spring IoC"><div class="hint">下一页<span class="arrow right"></span></div><div class="link">Spring IoC<!----></div></a></nav><!----><!----></main><!--]--><footer class="footer-wrapper"><div class="footer"><a href="https://beian.miit.gov.cn/#/Integrated/recordQuery" rel="noopener" target="_blank">沪ICP备20004238号-1</a></div><div class="copyright">Copyright © 2022 Li Zhuliang</div></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.6f02f33f.js" defer></script>
  </body>
</html>
